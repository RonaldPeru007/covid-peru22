---
title: "Grafico borrado"
output: html_notebook
---

El MINSA borró el gráfico de barras apiladas que mostraba los muertos por COVID según estado de vacunación.
Puede verse mas al respecto en este hilo https://twitter.com/gjrossir/status/1471474649678684174
Este script hace las cuentas para recrearlo
Tambien, ver script de python que obtiene y archiva la data

```{r}
library(dplyr)
library(lubridate)
library(readr)
library(stringr)
```

```{r}
cdc <- 
    read_csv("2022_01_06_TB_FALLECIDO_HOSP_VAC.csv") %>% 
    mutate_at(vars(contains("fecha")), function(x){ as.Date(x, format="%d/%m/%Y") }) %>% 
    mutate(semana_muerte = paste0(year(fecha_fallecimiento), "|", str_pad(week(fecha_fallecimiento), 2, pad="0")))
x <- cdc
```

```{r}
muertos <- 
    x %>% 
    filter( 
        fecha_fallecimiento >= as.Date("09/02/2021","%d/%m/%Y"),
        # cdc_fallecido_covid > 0
    )
```


```{r}
resumen <- 
    muertos %>% 
    group_by(semana_muerte) %>% 
    mutate(total_muertos_semana = n()) %>% 
    summarise(
        no_vac = sum(if_else(flag_vacuna == 0, 1, 0)) ,
        una_vac = sum(if_else(flag_vacuna == 1, 1, 0)) ,
        dos_vac = sum(if_else(flag_vacuna == 2, 1, 0)) ,
        tres_vac = sum(if_else(flag_vacuna == 3, 1, 0)) ,
        total_muertos_semana = total_muertos_semana[1]
    ) %>% 
    mutate(
        `No vacunado (%)` = no_vac/total_muertos_semana ,
        `1 vacuna (%)` = una_vac/total_muertos_semana ,
        `2 vacunas (%)` = dos_vac/total_muertos_semana ,
        `3 vacunas (%)` = tres_vac/total_muertos_semana ,
    )
```


Primera version para grafico de barras horizontal, no se vio tan bien
```{r}
hoy <- Sys.Date()
resumen %>% write_csv(paste0(hoy, "test.csv"))
```


Segunda version con barras verticales, como el original
```{r}
transposed <- 
    select(resumen, -no_vac, -una_vac, -dos_vac, -tres_vac, -total_muertos_semana) %>% 
    # mutate(semana_muerte = as.character(as.integer(semana_muerte))) %>% 
    mutate_at(vars(contains("%")), function(x) {round(x*100, 2)}) %>% 
    t() %>%
    as.data.frame()

colnames(transposed) <- resumen$semana_muerte
transposed$estado_vacunacion <- rownames(transposed)
rownames(transposed) <- NULL
transposed %>%
    filter(estado_vacunacion != "semana_muerte") %>%
    # rename(estado_vacunacion = semana_muerte) %>% 
    select(estado_vacunacion, everything()) %>%
    write_csv(paste0(hoy, "test2.csv"))
```
    